<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Bui Huy Giap&#x27;s personal website and blog">
    <title>
      
        
          A random number generator that I can remember |
        

        Zap&#x27;s website
      
    </title>
    <link rel="stylesheet" href="/styles/base.css">
    <link rel="stylesheet" href="/styles/nav.css">
    <link rel="stylesheet" href="/styles/footer.css">
    <link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS">
    
  

  <link rel="stylesheet" href="/styles/page.css">

  </head>
  <body>
    
      <div class="nav__bg">
        <div class="nav__container">
          

<nav class="nav">
  <h3 class="nav__title">
    <a href="/" class="nav__title__link">Zap</a>
  </h3>
  <ul class="nav__links">
    
      <li><a class="nav__link" href="/works">Works</a></li>
    
      <li><a class="nav__link" href="/blog">Blog</a></li>
    
      <li><a class="nav__link" href="/about">About</a></li>
    
  </ul>
</nav>

        </div>
      </div>
    

    <div class="container">
      <main class="content">
        
  
  <header class="post-header">
    
    <h1 class="post-header__title title">A random number generator that I can remember</h1>
    
    
      <div class="post-header__meta">
        <div class="post-header__data">
          
  <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
  <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
  <path d="M128 0c17.7 0 32 14.3 32 32V64H288V32c0-17.7 14.3-32 32-32s32 14.3 32 32V64h48c26.5 0 48 21.5 48 48v48H0V112C0 85.5 21.5 64 48 64H96V32c0-17.7 14.3-32 32-32zM0 192H448V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V192zm64 80v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16zm128 0v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H208c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H336zM64 400v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H208zm112 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H336c-8.8 0-16 7.2-16 16z"/>
</svg>


          Tue, Mar 05 2024
        </div>

        <div class="post-header__data">
          
  <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
  <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
  <path d="M256 0a256 256 0 1 1 0 512A256 256 0 1 1 256 0zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/>
</svg>


          
  
  

  <abbr title="927 words">
    4
    
      minutes
    
    read
  </abbr>

        </div>
      </div>
    
  </header>


  <article class="content__body">
    <p>I use (pseudo-)random number generators (RNGs) all the time. They’re an
essential part of my code. Recently, I prefer using a custom generator instead
of the default ones because:</p>
<ul>
<li>NumPy’s new <a href="//numpy.org/doc/stable/reference/random/generator.html#numpy.random.Generator">Generator
API</a>
feels so much better than the old global API.</li>
<li>The default ones are often too big and slow, for example, C++’s
<a href="//en.cppreference.com/w/cpp/numeric/random/mersenne_twister_engine">std::mt19937</a>.</li>
</ul>
<p>There are plenty of custom generators to choose from, but I still designed one
myself so that I can quickly code one from memory whenever I need to.</p>
<span id="continue-reading"></span><h1 id="the-generator">The generator</h1>
<p>If you just want to see the generator, here it is:</p>
<pre data-lang="c" style="background-color:#282c34;color:#dcdfe4;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#c678dd;">const </span><span>uint64_t MUL </span><span style="color:#c678dd;">= </span><span style="color:#e5c07b;">0x9e3779b97f4a7c55</span><span>;
</span><span>
</span><span>uint32_t </span><span style="color:#61afef;">rng_next</span><span>(uint64_t </span><span style="color:#c678dd;">*</span><span style="color:#e06c75;">state</span><span>) {
</span><span>    uint64_t s </span><span style="color:#c678dd;">= *</span><span>state;
</span><span>    </span><span style="color:#c678dd;">*</span><span>state </span><span style="color:#c678dd;">=</span><span> s </span><span style="color:#c678dd;">*</span><span> MUL </span><span style="color:#c678dd;">+ </span><span style="color:#e5c07b;">1</span><span>;
</span><span>
</span><span>    uint64_t w </span><span style="color:#c678dd;">= </span><span>(s </span><span style="color:#c678dd;">^ </span><span>(s </span><span style="color:#c678dd;">&gt;&gt; </span><span style="color:#e5c07b;">24</span><span>)) </span><span style="color:#c678dd;">* </span><span>(s </span><span style="color:#c678dd;">^</span><span> MUL);
</span><span>    </span><span style="color:#c678dd;">return </span><span>(w </span><span style="color:#c678dd;">^ </span><span>(w </span><span style="color:#c678dd;">&gt;&gt; </span><span style="color:#e5c07b;">24</span><span>)) </span><span style="color:#c678dd;">&gt;&gt; </span><span style="color:#e5c07b;">32</span><span>;
</span><span>}
</span></code></pre>
<p>It is an RNG based on the <a href="//www.pcg-random.org">PCG family</a> of pseudo-random
number generators by Dr. M.E. O’Neill. The generator can be split into two
parts: the Linear Congruential Generator and the output mixing/permutation.</p>
<h2 id="the-lcg-part">The LCG part</h2>
<p>The Linear Congruential Generator is defined by the following recurrence
relation:</p>
<pre style="background-color:#282c34;color:#dcdfe4;"><code><span>x[n] = (x[n - 1] * MUL + INC) % MOD
</span></code></pre>
<p>Choosing <code>MOD</code> and <code>INC</code> is easy. Because C uses wrapping addition and
multiplication by default, we don’t have to even choose <code>MOD</code>. Using <code>uint64_t</code>
for the state is equivalent to choosing <code>2^64</code> for <code>MOD</code>. <code>INC</code> can be any odd
number, so I choose <code>1</code> because I’m boring, and because I need to remember it.</p>
<p>Choosing <code>MUL</code> is a bit trickier. There are some constraints that I won’t go
into detail about, but here’s a formula for <code>MUL</code> that I can easily evaluate
using Python.</p>
<pre data-lang="python" style="background-color:#282c34;color:#dcdfe4;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#e06c75;">MUL </span><span style="color:#c678dd;">= </span><span style="color:#e06c75;">isqrt</span><span>(</span><span style="color:#e5c07b;">5 </span><span style="color:#c678dd;">* </span><span style="color:#e5c07b;">2 </span><span style="color:#c678dd;">** </span><span>(</span><span style="color:#e5c07b;">63 </span><span style="color:#c678dd;">* </span><span style="color:#e5c07b;">2</span><span>)) </span><span style="color:#c678dd;">- </span><span style="color:#e5c07b;">2 </span><span style="color:#c678dd;">** </span><span style="color:#e5c07b;">63 </span><span style="color:#c678dd;">+ </span><span style="color:#e5c07b;">64
</span></code></pre>
<p>This gives the number shown in hexadecimal above. To remember the formula, I
just have to remember that <code>MUL * ϕ = MOD</code> where <code>ϕ</code> is the <a href="//en.wikipedia.org/wiki/Golden_ratio">golden
ratio</a>, and the hexadecimal
representation of <code>MUL</code> ends with <code>0x55</code>. This is not a great multiplier, but
its weaknesses will be masked by a good output permutation.</p>
<h2 id="output-permutation">Output permutation</h2>
<p>The output permutation is inspired by the <code>RXS-M-XS</code> and <code>DXSM</code> permutation
functions from the PCG family. It violated several of Dr. O’Neill’s rules for
designing an output permutation. Read <a href="//www.pcg-random.org/pdf/hmc-cs-2014-0905.pdf">her
paper</a> to learn more. However,
the output permutation is easy to remember, decently fast and has good
statistical quality. It can be broken down into three steps:</p>
<pre data-lang="c" style="background-color:#282c34;color:#dcdfe4;" class="language-c "><code class="language-c" data-lang="c"><span>uint32_t </span><span style="color:#61afef;">output</span><span>(uint64_t </span><span style="color:#e06c75;">s</span><span>) {
</span><span>    </span><span style="color:#5c6370;">// xorshift
</span><span>    uint64_t w </span><span style="color:#c678dd;">= </span><span>(s </span><span style="color:#c678dd;">^ </span><span>(s </span><span style="color:#c678dd;">&gt;&gt; </span><span style="color:#e5c07b;">24</span><span>));
</span><span>    </span><span style="color:#5c6370;">// xor-multiply
</span><span>    w </span><span style="color:#c678dd;">*=</span><span> s </span><span style="color:#c678dd;">^</span><span> MUL;
</span><span>    </span><span style="color:#5c6370;">// xorshift-truncate
</span><span>    </span><span style="color:#c678dd;">return </span><span>(w </span><span style="color:#c678dd;">^ </span><span>(w </span><span style="color:#c678dd;">&gt;&gt; </span><span style="color:#e5c07b;">24</span><span>)) </span><span style="color:#c678dd;">&gt;&gt; </span><span style="color:#e5c07b;">32</span><span>;
</span><span>}
</span></code></pre>
<p>I chose this permutation function because I think that multiplication is a very
good bit-mixing operation. However, because the LCG is already a multiplication
and an addition, performing yet another multiplication is useless because the
permutation will commute with the LCG. So I added a xorshift in between and
also xor-ed the multiplier with the state. The last part is literally copied
from <code>RXS-M-XS</code>.</p>
<h1 id="how-good-is-it">How good is it?</h1>
<h2 id="speed-and-size">Speed and size</h2>
<p>Compiling down to x86 with clang17 and <code>-O3 -march=native</code>, this is the
generated assembly of the output permutation of <code>RXS-M-XS</code>, <code>XSH-RR</code>, and my
custom RNG.</p>
<pre data-lang="asm" style="background-color:#282c34;color:#dcdfe4;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#61afef;">pcg_custom:                             # @pcg_custom
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">mov     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e06c75;">rdi
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e5c07b;">24
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">xor     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e06c75;">rdi
</span><span style="color:#61afef;">    movabs  </span><span style="color:#e06c75;">rcx</span><span>, -</span><span style="color:#e5c07b;">7046029254386353067
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">xor     </span><span style="color:#e06c75;">rcx</span><span>, </span><span style="color:#e06c75;">rdi
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">imul    </span><span style="color:#e06c75;">rcx</span><span>, </span><span style="color:#e06c75;">rax
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">mov     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e06c75;">rcx
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e5c07b;">56
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rcx</span><span>, </span><span style="color:#e5c07b;">32
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">xor     </span><span style="color:#e06c75;">eax</span><span>, </span><span style="color:#e06c75;">ecx
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">ret
</span><span style="color:#61afef;">pcg_rxs_m_xs:                         # @pcg_rxs_m_xs
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">mov     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e06c75;">rdi
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e5c07b;">59
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">add     </span><span style="color:#e06c75;">al</span><span>, </span><span style="color:#e5c07b;">5
</span><span style="color:#61afef;">    shrx    </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e06c75;">rdi</span><span>, </span><span style="color:#e06c75;">rax
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">xor     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e06c75;">rdi
</span><span style="color:#61afef;">    movabs  </span><span style="color:#e06c75;">rcx</span><span>, -</span><span style="color:#e5c07b;">5840758589994634535
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">imul    </span><span style="color:#e06c75;">rcx</span><span>, </span><span style="color:#e06c75;">rax
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">mov     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e06c75;">rcx
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e5c07b;">54
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rcx</span><span>, </span><span style="color:#e5c07b;">32
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">xor     </span><span style="color:#e06c75;">eax</span><span>, </span><span style="color:#e06c75;">ecx
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">ret
</span><span style="color:#61afef;">pcg_xsh_rr:                             # @pcg_xsh_rr
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">mov     </span><span style="color:#e06c75;">rcx</span><span>, </span><span style="color:#e06c75;">rdi
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">mov     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e06c75;">rdi
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rax</span><span>, </span><span style="color:#e5c07b;">45
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">mov     </span><span style="color:#e06c75;">rdx</span><span>, </span><span style="color:#e06c75;">rdi
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rdx</span><span>, </span><span style="color:#e5c07b;">27
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">xor     </span><span style="color:#e06c75;">eax</span><span>, </span><span style="color:#e06c75;">edx
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">shr     </span><span style="color:#e06c75;">rcx</span><span>, </span><span style="color:#e5c07b;">59
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">ror     </span><span style="color:#e06c75;">eax</span><span>, </span><span style="color:#e06c75;">cl
</span><span style="color:#61afef;">    </span><span style="color:#c678dd;">ret
</span></code></pre>
<p>As you can see, my output permutation has one less instruction than <code>RXS-M-XS</code>,
but two more than <code>XSH-RR</code>. So in theory, it’s slightly faster than <code>RXS-M-XS</code>
but slightly slower than <code>XSH-RR</code>. Moreover, multiplication is expensive, and
the <code>XSH-RR</code> version doesn’t have one, so it might be even faster. I don’t have
a good way to actually measure the speed of these RNGs, so showing the
generated assembly is the best that I can do.</p>
<h2 id="statistical-quality">Statistical quality</h2>
<p>My generator easily passes
<a href="//simul.iro.umontreal.ca/testu01/tu01.html">BigCrush</a>. Passing statistical
tests doesn’t mean that the generator has good quality, but failing them 
doesn’t sound good for your RNG. Dr. O’Neill suggests testing a scaled-down
version, to make sure that the generator isn’t too big for statistical flaws to
be detected. So I created a 36-bit version of the generator and tested it. The
result is that it also passes BigCrush, which means that the generator I
designed is a good generator for its size.</p>
<h1 id="conclusion">Conclusion</h1>
<p>This is just a random number generator I designed for fun, and for when I need
to quickly make one from memory. I still use and recommend using the PCG
<code>XSH-RR</code> variant instead, because it’s faster and more well-tested. PCGs are
not optimal for generating 64-bit numbers for various reasons, but for
32-bit—which I mostly ever need—they are incredible. I highly recommend
reading Dr. O’Neill’s <a href="//www.pcg-random.org/blog/">blog</a> and
<a href="//www.pcg-random.org/pdf/hmc-cs-2014-0905.pdf">paper</a> to learn more about
RNGs. And be sure to check out other generators, such as
<a href="//prng.di.unimi.it/">Xoshiro256++</a>,
<a href="//pracrand.sourceforge.net/RNG_engines.txt">SFC64</a>, and
<a href="//github.com/wangyi-fudan/wyhash">WyRand</a>.</p>

  </article>

      </main>

      <footer class="footer__container">
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 352.5 960 188.5" preserveAspectRatio="none" class="footer__split">
  <path d="M0 441L22.8 424.5C45.7 408 91.3 375 137 360.8C182.7 346.7 228.3 351.3 274 369.3C319.7 387.3 365.3 418.7 411.2 414.2C457 409.7 503 369.3 548.8 368C594.7 366.7 640.3 404.3 686 421.7C731.7 439 777.3 436 823 429.8C868.7 423.7 914.3 414.3 937.2 409.7L960 405L960 541L937.2 541C914.3 541 868.7 541 823 541C777.3 541 731.7 541 686 541C640.3 541 594.7 541 548.8 541C503 541 457 541 411.2 541C365.3 541 319.7 541 274 541C228.3 541 182.7 541 137 541C91.3 541 45.7 541 22.8 541L0 541Z" fill="#f7f9fb"/>
  <path d="M0 477L22.8 467C45.7 457 91.3 437 137 423.8C182.7 410.7 228.3 404.3 274 401.7C319.7 399 365.3 400 411.2 413.5C457 427 503 453 548.8 464.2C594.7 475.3 640.3 471.7 686 456.5C731.7 441.3 777.3 414.7 823 404.5C868.7 394.3 914.3 400.7 937.2 403.8L960 407L960 541L937.2 541C914.3 541 868.7 541 823 541C777.3 541 731.7 541 686 541C640.3 541 594.7 541 548.8 541C503 541 457 541 411.2 541C365.3 541 319.7 541 274 541C228.3 541 182.7 541 137 541C91.3 541 45.7 541 22.8 541L0 541Z" fill="#eff3f7"/>
  <path d="M0 459L22.8 456.2C45.7 453.3 91.3 447.7 137 456.7C182.7 465.7 228.3 489.3 274 494.8C319.7 500.3 365.3 487.7 411.2 476C457 464.3 503 453.7 548.8 451.7C594.7 449.7 640.3 456.3 686 462.5C731.7 468.7 777.3 474.3 823 473.2C868.7 472 914.3 464 937.2 460L960 456L960 541L937.2 541C914.3 541 868.7 541 823 541C777.3 541 731.7 541 686 541C640.3 541 594.7 541 548.8 541C503 541 457 541 411.2 541C365.3 541 319.7 541 274 541C228.3 541 182.7 541 137 541C91.3 541 45.7 541 22.8 541L0 541Z" fill="#e8eef4" stroke="#e8eef4"/>
</svg>

  <div class="footer__bg">
    <div class="footer">
      &copy; 2024 Zap (Huy-Giap Bui).
      Content on this site is licensed under <a href="//creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.
    </div>

    
  </div>
</footer>

    </div>
  </body>
</html>
